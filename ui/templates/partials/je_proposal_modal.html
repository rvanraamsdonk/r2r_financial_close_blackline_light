<!-- Journal Entry Proposal Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" id="je-modal">
  <!-- Modal Content -->
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
    <!-- Header -->
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold">Propose Journal Entry</h3>
        <div class="text-sm text-gray-600">{{ je.module }} - {{ je.scenario }}</div>
      </div>
      <button class="text-gray-500 hover:text-gray-700" onclick="closeJEModal()">✕</button>
    </div>

    <!-- Content -->
    <div class="p-6 overflow-y-auto max-h-[70vh]">
      <!-- JE Header Info -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded">
        <div>
          <div class="text-xs text-gray-500">Entity</div>
          <div class="font-medium">{{ je.entity }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Period</div>
          <div class="font-medium">{{ je.period }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Total Amount</div>
          <div class="font-medium">${{ '%.2f'|format(je.total_debits) }}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">Status</div>
          <div class="font-medium">
            <span class="px-2 py-1 rounded text-xs {% if je.status.value == 'draft' %}bg-gray-100 text-gray-800{% elif je.status.value == 'pending' %}bg-yellow-100 text-yellow-800{% elif je.status.value == 'approved' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
              {{ je.status.value|title }}
            </span>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Description</label>
        <textarea class="w-full border rounded px-3 py-2 text-sm" rows="2" readonly>{{ je.description }}</textarea>
      </div>

      <!-- JE Lines -->
      <div class="mb-6">
        <h4 class="text-sm font-medium mb-3">Journal Entry Lines</h4>
        <div class="border rounded overflow-hidden">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left px-3 py-2">Account</th>
                <th class="text-left px-3 py-2">Description</th>
                <th class="text-right px-3 py-2">Debit</th>
                <th class="text-right px-3 py-2">Credit</th>
              </tr>
            </thead>
            <tbody>
              {% for line in je.lines %}
              <tr class="border-t">
                <td class="px-3 py-2 font-mono">{{ line.account }}</td>
                <td class="px-3 py-2">{{ line.description }}</td>
                <td class="px-3 py-2 text-right">
                  {% if line.debit > 0 %}{{ '%.2f'|format(line.debit) }}{% endif %}
                </td>
                <td class="px-3 py-2 text-right">
                  {% if line.credit > 0 %}{{ '%.2f'|format(line.credit) }}{% endif %}
                </td>
              </tr>
              {% endfor %}
              <!-- Totals Row -->
              <tr class="border-t bg-gray-50 font-medium">
                <td class="px-3 py-2" colspan="2">Totals</td>
                <td class="px-3 py-2 text-right">${{ '%.2f'|format(je.total_debits) }}</td>
                <td class="px-3 py-2 text-right">${{ '%.2f'|format(je.total_credits) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Balance Check -->
        <div class="mt-2 text-sm">
          {% if je.is_balanced %}
            <span class="text-green-600">✓ Journal entry is balanced</span>
          {% else %}
            <span class="text-red-600">⚠ Journal entry is not balanced (difference: ${{ '%.2f'|format(je.total_debits - je.total_credits) }})</span>
          {% endif %}
        </div>
      </div>

      <!-- Source Data -->
      <div class="mb-6">
        <h4 class="text-sm font-medium mb-3">Source Data</h4>
        <div class="bg-gray-50 rounded p-3 text-sm">
          <pre class="whitespace-pre-wrap">{{ je.source_data | tojson(indent=2) }}</pre>
        </div>
      </div>

      <!-- Approval Workflow (if applicable) -->
      {% if workflow_status %}
      <div class="mb-6">
        <h4 class="text-sm font-medium mb-3">Approval Workflow</h4>
        <div class="space-y-2">
          {% for step in workflow_status.steps %}
          <div class="flex items-center justify-between p-3 border rounded">
            <div>
              <div class="font-medium">{{ step.approver_role|title }}</div>
              <div class="text-sm text-gray-600">{{ step.approver_id }}</div>
            </div>
            <div class="text-right">
              <div class="text-sm">
                <span class="px-2 py-1 rounded text-xs {% if step.status == 'approved' %}bg-green-100 text-green-800{% elif step.status == 'rejected' %}bg-red-100 text-red-800{% elif step.status == 'pending' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                  {{ step.status|title }}
                </span>
              </div>
              {% if step.timestamp %}
              <div class="text-xs text-gray-500">{{ step.timestamp }}</div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Footer Actions -->
    <div class="px-6 py-4 border-t flex justify-end gap-3">
      <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="closeJEModal()">
        Cancel
      </button>
      
      {% if je.status.value == 'draft' %}
      <button type="button" 
              class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded"
              hx-post="/je/submit/{{ je.id }}"
              hx-target="#je-modal"
              hx-swap="outerHTML">
        Submit for Approval
      </button>
      {% elif je.status.value == 'pending' and can_approve %}
      <button type="button" 
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded"
              hx-post="/je/approve/{{ je.id }}?action=reject"
              hx-target="#je-modal"
              hx-swap="outerHTML">
        Reject
      </button>
      <button type="button" 
              class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded"
              hx-post="/je/approve/{{ je.id }}?action=approve"
              hx-target="#je-modal"
              hx-swap="outerHTML">
        Approve
      </button>
      {% elif je.status.value == 'approved' %}
      <button type="button" 
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded"
              hx-post="/je/post/{{ je.id }}"
              hx-target="#je-modal"
              hx-swap="outerHTML">
        Post to GL
      </button>
      {% endif %}
    </div>
  </div>
</div>

<script>
function closeJEModal() {
  document.getElementById('je-modal').remove();
}
</script>
