<div class="fixed inset-0 z-40">
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black/30" hx-get="/partials/close-drawer" hx-target="#drawer-root" hx-swap="innerHTML"></div>
  <!-- Drawer -->
  <aside class="absolute right-0 top-0 h-full w-full max-w-xl bg-white shadow-xl flex flex-col">
    <!-- Header -->
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <div id="drawer-header">
        <div class="text-xs uppercase text-gray-500">{{ d.module }} Details</div>
        <div class="text-sm font-semibold">{{ d.header.entity }} · {{ d.header.account }} · {{ d.header.period }}{% if d.header.basis %} · {{ d.header.basis }}{% endif %}</div>
      </div>
      <button class="text-gray-500 hover:text-gray-700" aria-label="Close" hx-get="/partials/close-drawer" hx-target="#drawer-root" hx-swap="innerHTML">✕</button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="drawer-content">
      <!-- Exception Summary -->
      <section class="bg-gray-50 border rounded p-3">
        <div class="text-xs uppercase text-gray-500 mb-2">Exception Summary</div>
        {% if d.module == 'FX' %}
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div>Computed USD: <span class="font-medium">{{ '%.2f'|format(d.metrics.computed_usd or 0) }}</span></div>
            <div>Reported USD: <span class="font-medium">{{ '%.2f'|format(d.metrics.reported_usd or 0) }}</span></div>
            <div>Diff USD: <span class="font-semibold {% if (d.metrics.diff_usd or 0) >= 0 %}text-emerald-700{% else %}text-rose-700{% endif %}">{{ '%.2f'|format(d.metrics.diff_usd or 0) }}</span></div>
            <div>Rate: <span class="font-medium">{{ d.metrics.rate }}</span></div>
            <div>Tolerance USD: <span class="font-medium">{{ d.threshold }}</span></div>
          </div>
        {% elif d.module == 'Flux' %}
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div>Actual USD: <span class="font-medium">{{ '%.0f'|format(d.metrics.actual_usd or 0) }}</span></div>
            <div>Budget USD: <span class="font-medium">{{ '%.0f'|format(d.metrics.budget_amount or 0) }}</span></div>
            <div>Prior USD: <span class="font-medium">{{ '%.0f'|format(d.metrics.prior_usd or 0) }}</span></div>
            <div>Var vs Budget: <span class="font-semibold {% if (d.metrics.var_vs_budget or 0) >= 0 %}text-emerald-700{% else %}text-rose-700{% endif %}">{{ '%.0f'|format(d.metrics.var_vs_budget or 0) }}</span></div>
            <div>Var vs Prior: <span class="font-semibold {% if (d.metrics.var_vs_prior or 0) >= 0 %}text-emerald-700{% else %}text-rose-700{% endif %}">{{ '%.0f'|format(d.metrics.var_vs_prior or 0) }}</span></div>
            <div>Threshold USD: <span class="font-medium">{{ '%.0f'|format(d.threshold or 0) }}</span></div>
          </div>
        {% elif d.module == 'Bank' %}
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div>Transaction ID: <span class="font-mono text-xs">{{ d.metrics.bank_txn_id }}</span></div>
            <div>Amount: <span class="font-semibold {% if (d.metrics.amount or 0) >= 0 %}text-emerald-700{% else %}text-rose-700{% endif %}">{{ d.metrics.currency }} {{ '%.2f'|format(d.metrics.amount or 0) }}</span></div>
            <div>Date: <span class="font-medium">{{ d.metrics.date }}</span></div>
            <div>Type: <span class="font-medium">{{ d.metrics.transaction_type }}</span></div>
            <div>Counterparty: <span class="font-medium">{{ d.metrics.counterparty }}</span></div>
            <div>Classification: <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if d.metrics.classification == 'forensic_risk' %}bg-red-200 text-red-900{% else %}bg-yellow-200 text-yellow-900{% endif %}">{{ d.metrics.classification.replace('_', ' ').title() if d.metrics.classification else 'Unknown' }}</span></div>
          </div>
        {% else %}
          <div class="text-sm text-gray-600">No metrics available.</div>
        {% endif %}
        
        <!-- AI Analysis Section (for all modules) -->
        {% if d.ai_narrative and (d.ai_narrative.narrative or d.ai_narrative.business_driver) %}
          <div class="mt-3 p-3 border rounded bg-white">
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs uppercase text-gray-500">AI Analysis</div>
              {% if d.ai_narrative.confidence %}
                <span class="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800 text-xs font-medium">{{ '%.0f'|format((d.ai_narrative.confidence * 100)|round) }}% confidence</span>
              {% endif %}
            </div>
            {% if d.ai_narrative.narrative %}
              <div class="text-sm text-gray-800 mb-2">{{ d.ai_narrative.narrative }}</div>
            {% endif %}
            <div class="flex flex-wrap gap-2 text-xs">
              {% if d.ai_narrative.business_driver %}
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">Driver: {{ d.ai_narrative.business_driver }}</span>
              {% endif %}
              {% if d.ai_narrative.risk_level %}
                <span class="px-2 py-1 rounded {% if d.ai_narrative.risk_level == 'Critical' %}bg-red-100 text-red-800{% elif d.ai_narrative.risk_level == 'High' %}bg-orange-100 text-orange-800{% elif d.ai_narrative.risk_level == 'Medium' %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}">Risk: {{ d.ai_narrative.risk_level }}</span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </section>

      <!-- Evidence -->
      <section class="bg-gray-50 border rounded p-3">
        <div class="text-xs uppercase text-gray-500 mb-2">Evidence</div>
        {% if d.evidence and d.evidence|length > 0 %}
          <ul class="space-y-2">
            {% for ev in d.evidence %}
              <li class="text-sm flex items-start justify-between">
                <div>
                  <div class="font-medium">{{ ev.type|capitalize }} · {{ ev.source }}</div>
                  <div class="text-gray-600">{{ ev.snippet }}</div>
                  <div class="text-xs text-gray-500">{{ ev.ts }}</div>
                </div>
                <div class="ml-3 text-xs">
                  <span class="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800">conf {{ '%.2f'|format(ev.confidence or 0) }}</span>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-gray-600">No evidence found.</div>
        {% endif %}
      </section>

      <!-- AI Provenance -->
      <section class="bg-gray-50 border rounded p-3">
        <div class="text-xs uppercase text-gray-500 mb-2">AI Provenance</div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>Run ID: <span class="font-mono">{{ d.run_id }}</span></div>
          <div>Model: <span class="font-medium">{{ d.provenance.model or '—' }}</span></div>
        </div>
        {% if d.provenance.prompt %}
          <div class="mt-2 text-xs text-gray-600">Prompt: <span class="font-mono">{{ d.provenance.prompt }}</span></div>
        {% else %}
          <div class="mt-2 text-xs text-gray-500">No prompt metadata available.</div>
        {% endif %}
      </section>
    </div>
  </aside>
</div>
