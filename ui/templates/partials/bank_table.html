{% for r in bank.exceptions %}
{% set is_forensic = r.classification == 'forensic_risk' %}
{% set is_high_amount = (r.amount|abs) > 50000 %}
<tr class="border-t {% if is_forensic %}bg-red-50{% elif is_high_amount %}bg-amber-50{% endif %}">
  <td class="px-2 py-2 text-center">
    <a title="Details" class="text-gray-500 hover:text-indigo-600" hx-get="/details?module=Bank&period={{ bank.period }}&entity={{ r.entity }}&txn_id={{ r.bank_txn_id }}" hx-target="#drawer-root" hx-swap="innerHTML">üîç</a>
  </td>
  <td class="px-3 py-2">{{ r.entity }}</td>
  <td class="px-3 py-2">{{ r.date }}</td>
  <td class="px-3 py-2 font-mono text-xs">{{ r.bank_txn_id }}</td>
  <td class="px-3 py-2 text-right font-medium {% if r.amount >= 0 %}text-emerald-700{% else %}text-rose-700{% endif %}">
    {{ r.currency }} {{ '%.2f'|format(r.amount) }}
  </td>
  <td class="px-3 py-2">{{ r.counterparty }}</td>
  <td class="px-3 py-2">{{ r.transaction_type }}</td>
  <td class="px-3 py-2">
    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
      {% if r.reason == 'unusual_counterparty' %}bg-red-100 text-red-800
      {% elif r.reason == 'velocity_anomaly' %}bg-orange-100 text-orange-800
      {% elif r.reason == 'timing_difference' %}bg-yellow-100 text-yellow-800
      {% else %}bg-gray-100 text-gray-800{% endif %}">
      {{ r.reason.replace('_', ' ').title() }}
    </span>
  </td>
  <td class="px-3 py-2">
    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
      {% if r.classification == 'forensic_risk' %}bg-red-200 text-red-900
      {% elif r.classification == 'timing_difference' %}bg-yellow-200 text-yellow-900
      {% else %}bg-gray-200 text-gray-900{% endif %}">
      {{ r.classification.replace('_', ' ').title() }}
    </span>
  </td>
  <td class="px-2 py-2 text-center">
    {% if is_forensic or is_high_amount %}
    <button type="button" 
            class="inline-flex items-center px-2 py-1 text-xs font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded border border-indigo-200 transition-colors"
            hx-post="/je/propose"
            hx-vals='{"module": "Bank", "scenario": "bank_reconciliation", "source_data": {{ r | tojson }}, "period": "{{ bank.period }}", "entity": "{{ r.entity }}"}'
            hx-target="body"
            hx-swap="beforeend"
            title="Propose journal entry for bank reconciliation adjustment">
      <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      JE
    </button>
    {% endif %}
  </td>
</tr>
{% else %}
<tr>
  <td colspan="10" class="px-3 py-6 text-center text-gray-500">No exceptions match current filters.</td>
</tr>
{% endfor %}
