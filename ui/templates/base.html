<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>R2R Close Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
        /* Refined Business UI Styling */
        :root {
            --bs-body-font-size: 0.8125rem;
            --bs-body-line-height: 1.3;
            --refined-gray-50: #fafafa;
            --refined-gray-100: #f5f5f5;
            --refined-gray-200: #e5e5e5;
            --refined-gray-300: #d4d4d4;
            --refined-gray-400: #a3a3a3;
            --refined-gray-500: #737373;
            --refined-gray-600: #525252;
            --refined-gray-700: #404040;
            --refined-gray-800: #262626;
            --refined-success: #059669;
            --refined-warning: #d97706;
            --refined-danger: #dc2626;
            --refined-info: #0284c7;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.8125rem;
            line-height: 1.3;
            color: var(--refined-gray-700);
            background-color: var(--refined-gray-50);
        }
        
        .navbar {
            background-color: var(--refined-gray-800) !important;
            border-bottom: 1px solid var(--refined-gray-200);
            padding: 0.5rem 0;
        }
        
        .navbar-brand {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .nav-link {
            font-size: 0.8125rem;
            padding: 0.25rem 0.5rem !important;
        }
        
        h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--refined-gray-800);
        }
        
        h6 {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--refined-gray-600);
        }
        
        .card {
            border: 1px solid var(--refined-gray-200);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: var(--refined-gray-50);
            border-bottom: 1px solid var(--refined-gray-200);
            padding: 0.75rem 1rem;
        }
        
        .table {
            font-size: 0.75rem;
        }
        
        .table th {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            color: var(--refined-gray-600);
            border-bottom: 1px solid var(--refined-gray-200);
            padding: 0.375rem 0.25rem;
            vertical-align: middle;
        }
        
        .table td {
            padding: 0.25rem 0.25rem;
            border-bottom: 1px solid var(--refined-gray-100);
            vertical-align: middle;
            line-height: 1.2;
        }
        
        .badge {
            font-size: 0.625rem;
            font-weight: 500;
            padding: 0.125rem 0.375rem;
            border-radius: 0.1875rem;
        }
        
        .badge.bg-success {
            background-color: var(--refined-success) !important;
        }
        
        .badge.bg-warning {
            background-color: var(--refined-warning) !important;
        }
        
        .badge.bg-danger {
            background-color: var(--refined-danger) !important;
        }
        
        .badge.bg-info, .badge.bg-primary {
            background-color: var(--refined-info) !important;
        }
        
        .badge.bg-secondary {
            background-color: var(--refined-gray-500) !important;
        }
        
        .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.1875rem;
            font-weight: 500;
        }
        
        .btn-sm {
            font-size: 0.6875rem;
            padding: 0.125rem 0.375rem;
        }
        
        .btn-outline-info {
            color: var(--refined-info);
            border-color: var(--refined-gray-300);
        }
        
        .btn-outline-info:hover {
            background-color: var(--refined-info);
            border-color: var(--refined-info);
        }
        
        .btn-outline-success {
            color: var(--refined-success);
            border-color: var(--refined-gray-300);
        }
        
        .btn-outline-success:hover {
            background-color: var(--refined-success);
            border-color: var(--refined-success);
        }
        
        .btn-outline-primary {
            color: var(--refined-info);
            border-color: var(--refined-gray-300);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--refined-info);
            border-color: var(--refined-info);
        }
        
        .form-select, .form-control {
            font-size: 0.75rem;
            border-color: var(--refined-gray-300);
            padding: 0.25rem 0.5rem;
        }
        
        .form-select-sm, .form-control-sm {
            font-size: 0.6875rem;
            padding: 0.125rem 0.375rem;
        }
        
        .text-muted {
            color: var(--refined-gray-500) !important;
        }
        
        .small {
            font-size: 0.6875rem;
        }
        
        /* High density table styling */
        .table-sm th,
        .table-sm td {
            padding: 0.1875rem 0.25rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        /* Consistent font weights */
        .fw-medium {
            font-weight: 500;
        }
        
        .fw-semibold {
            font-weight: 600;
        }
        
        /* Compact card styling */
        .card-body {
            padding: 0.5rem;
        }
        
        .card-header {
            padding: 0.375rem 0.5rem;
        }
        
        .bg-light {
            background-color: var(--refined-gray-50) !important;
        }
        
        .border {
            border-color: var(--refined-gray-200) !important;
        }
        
        .text-success {
            color: var(--refined-success) !important;
        }
        
        .text-warning {
            color: var(--refined-warning) !important;
        }
        
        .text-danger {
            color: var(--refined-danger) !important;
        }
        
        .text-info {
            color: var(--refined-info) !important;
        }
        
        /* KPI Cards */
        .bg-light.border.rounded {
            background-color: white !important;
            border: 1px solid var(--refined-gray-200) !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 0.5rem !important;
        }
        
        .bg-light.border.rounded .fw-bold {
            font-size: 0.875rem;
        }
        
        .bg-light.border.rounded .text-muted {
            font-size: 0.6875rem;
        }
        
        /* Methodology section */
        .bg-light.border.rounded.p-2 {
            background-color: var(--refined-gray-50) !important;
            border: 1px solid var(--refined-gray-200) !important;
        }
        
        /* Progress bars */
        .progress {
            background-color: var(--refined-gray-200);
        }
        
        .progress-bar.bg-success {
            background-color: var(--refined-success) !important;
        }
        
        .progress-bar.bg-warning {
            background-color: var(--refined-warning) !important;
        }
        
        .progress-bar.bg-danger {
            background-color: var(--refined-danger) !important;
        }
        
        /* Table row highlighting */
        .table-success {
            background-color: rgba(5, 150, 105, 0.05) !important;
        }
        
        .table-warning {
            background-color: rgba(217, 119, 6, 0.05) !important;
        }
        
        .table-danger {
            background-color: rgba(220, 38, 38, 0.05) !important;
        }
        
        /* Drawer refinements */
        .position-fixed {
            backdrop-filter: blur(2px);
        }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">R2R Auto-Close</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/tb">TB</a></li>
                    <li class="nav-item"><a class="nav-link" href="/fx">FX</a></li>
                    <li class="nav-item"><a class="nav-link" href="/flux">Flux</a></li>
                    <li class="nav-item"><a class="nav-link" href="/bank">Bank</a></li>
                    <li class="nav-item"><a class="nav-link" href="/ap">AP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/ar">AR</a></li>
                    <li class="nav-item"><a class="nav-link" href="/intercompany">IC</a></li>
                    <li class="nav-item"><a class="nav-link" href="/hitl">Review Queue</a></li>
                </ul>
                <div class="d-flex">
                    <div class="text-light small" id="clock" hx-get="/partials/clock" hx-trigger="load, every 30s" hx-swap="outerHTML">Loading…</div>
                </div>
            </div>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Drawer root for slide-out details -->
    <div id="drawer-root"></div>
    
    <script>
      // Simple solution: disable HTMX on detail links when drawer is open
      function setupDrawerIntercept() {
        console.log('Setting up drawer intercept');
        
        // Override all detail links to check drawer state
        document.querySelectorAll('a[hx-get*="/details?"]').forEach(link => {
          link.addEventListener('click', function(evt) {
            const drawerOpen = document.querySelector('#drawer-root .fixed');
            console.log('Link clicked, drawer open:', !!drawerOpen);
            
            if (drawerOpen) {
              evt.preventDefault();
              evt.stopPropagation();
              
              const url = this.getAttribute('hx-get') + '&content_only=true';
              console.log('Making content request:', url);
              
              fetch(url)
                .then(response => response.text())
                .then(html => {
                  console.log('Got response, updating drawer');
                  
                  // Simple approach: look for OOB elements and update them
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = html;
                  
                  const oobElements = tempDiv.querySelectorAll('[hx-swap-oob]');
                  oobElements.forEach(el => {
                    const swapAttr = el.getAttribute('hx-swap-oob');
                    const targetSelector = swapAttr.split(':')[1];
                    const target = document.querySelector(targetSelector);
                    if (target) {
                      target.innerHTML = el.innerHTML;
                    }
                  });
                  
                  // If no OOB elements, update content directly
                  if (oobElements.length === 0) {
                    const content = document.getElementById('drawer-content');
                    if (content) {
                      content.innerHTML = html;
                    }
                  }
                })
                .catch(err => console.error('Fetch error:', err));
            }
          }, true);
        });
      }
      
      // Run on page load and after HTMX updates
      document.addEventListener('DOMContentLoaded', setupDrawerIntercept);
      document.addEventListener('htmx:afterSettle', setupDrawerIntercept);
      
      console.log('Drawer intercept script loaded');
    </script>
    
    <!-- Page-specific scripts -->
    {% block scripts %}{% endblock %}
  </body>
</html>
