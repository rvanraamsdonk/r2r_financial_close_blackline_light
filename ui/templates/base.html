<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>R2R Close Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
        .bg-success-soft {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid rgba(25, 135, 84, 0.2);
        }
        .bg-danger-soft {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        .bg-warning-soft {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        .bg-primary-soft {
            background-color: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
            border: 1px solid rgba(13, 110, 253, 0.2);
        }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">R2R Auto-Close</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/tb">TB</a></li>
                    <li class="nav-item"><a class="nav-link" href="/fx">FX</a></li>
                    <li class="nav-item"><a class="nav-link" href="/flux">Flux</a></li>
                    <li class="nav-item"><a class="nav-link" href="/bank">Bank</a></li>
                    <li class="nav-item"><a class="nav-link" href="/hitl">Review Queue</a></li>
                </ul>
                <div class="d-flex">
                    <div class="text-light small" id="clock" hx-get="/partials/clock" hx-trigger="load, every 30s" hx-swap="outerHTML">Loadingâ€¦</div>
                </div>
            </div>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Drawer root for slide-out details -->
    <div id="drawer-root"></div>
    
    <script>
      // Simple solution: disable HTMX on detail links when drawer is open
      function setupDrawerIntercept() {
        console.log('Setting up drawer intercept');
        
        // Override all detail links to check drawer state
        document.querySelectorAll('a[hx-get*="/details?"]').forEach(link => {
          link.addEventListener('click', function(evt) {
            const drawerOpen = document.querySelector('#drawer-root .fixed');
            console.log('Link clicked, drawer open:', !!drawerOpen);
            
            if (drawerOpen) {
              evt.preventDefault();
              evt.stopPropagation();
              
              const url = this.getAttribute('hx-get') + '&content_only=true';
              console.log('Making content request:', url);
              
              fetch(url)
                .then(response => response.text())
                .then(html => {
                  console.log('Got response, updating drawer');
                  
                  // Simple approach: look for OOB elements and update them
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = html;
                  
                  const oobElements = tempDiv.querySelectorAll('[hx-swap-oob]');
                  oobElements.forEach(el => {
                    const swapAttr = el.getAttribute('hx-swap-oob');
                    const targetSelector = swapAttr.split(':')[1];
                    const target = document.querySelector(targetSelector);
                    if (target) {
                      target.innerHTML = el.innerHTML;
                    }
                  });
                  
                  // If no OOB elements, update content directly
                  if (oobElements.length === 0) {
                    const content = document.getElementById('drawer-content');
                    if (content) {
                      content.innerHTML = html;
                    }
                  }
                })
                .catch(err => console.error('Fetch error:', err));
            }
          }, true);
        });
      }
      
      // Run on page load and after HTMX updates
      document.addEventListener('DOMContentLoaded', setupDrawerIntercept);
      document.addEventListener('htmx:afterSettle', setupDrawerIntercept);
      
      console.log('Drawer intercept script loaded');
    </script>
  </body>
</html>
