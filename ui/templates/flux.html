{% extends "base.html" %}

{% block title %}Flux Analysis{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-2">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h4 class="mb-1">Flux Analysis</h4>
            <small class="text-muted">AI analysis for {{ flux.period }} vs budget</small>
        </div>
    </div>

    <!-- KPI Row -->
    <div class="row g-2 mb-2">
        <div class="col-2">
            <div class="bg-light border rounded p-2 text-center">
                <div class="fw-bold text-danger">{{ forensic_count | length }}</div>
                <small class="text-muted">Exceptions</small>
            </div>
        </div>
        <div class="col-2">
            <div class="bg-light border rounded p-2 text-center">
                <div class="fw-bold text-success">{{ (flux.rows | length) - (forensic_count | length) }}</div>
                <small class="text-muted">Auto-Approved</small>
            </div>
        </div>
        <div class="col-2">
            <div class="bg-light border rounded p-2 text-center">
                <div class="fw-bold">95%</div>
                <small class="text-muted">Avg. Confidence</small>
            </div>
        </div>
        <div class="col-2">
            <div class="bg-light border rounded p-2 text-center">
                <div class="fw-bold">{{ flux.rows | length }}</div>
                <small class="text-muted">Total Items</small>
            </div>
        </div>
        <div class="col-2">
            <div class="bg-light border rounded p-2 text-center">
                <div class="fw-bold">{{ flux.period }}</div>
                <small class="text-muted">Period</small>
            </div>
        </div>
        <div class="col-2">
            <div class="bg-light border rounded p-2 text-center">
                <span class="badge bg-secondary">AI</span>
                <small class="text-muted d-block">Analysis Type</small>
            </div>
        </div>
    </div>

    <!-- Methodology -->
    <div class="bg-light border rounded p-2 mb-2">
        <div class="row g-2 align-items-center">
            <div class="col-auto">
                <span class="badge bg-secondary">AI</span>
            </div>
            <div class="col">
                <small class="text-muted me-3">Basis: <strong>Actual vs Budget</strong></small>
                <small class="text-muted me-3">Method: <strong>{{ (flux.rules.threshold_basis or 'default').replace('_', ' ').title() }}</strong></small>
                <small class="text-muted me-3">Floor: <strong>{{ flux.rules.default_floor_usd | format_currency }}</strong></small>
                <small class="text-muted">Narratives: <strong>{{ flux.rows | length }}</strong></small>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <form method="GET" action="/flux">
        <div class="bg-light border rounded p-2 mb-2">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <select id="entityFilter" name="entity" class="form-select form-select-sm">
                        <option value="" {% if not flux.selected_entity %}selected{% endif %}>All Entities</option>
                        {% for entity in flux.entities %}
                        <option value="{{ entity }}" {% if flux.selected_entity == entity %}selected{% endif %}>{{ entity }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <select id="riskFilter" name="risk" class="form-select form-select-sm">
                        <option value="">All Risk Levels</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Apply</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">Clear</button>
                </div>
                <div class="col">
                    <div class="btn-group btn-group-sm ms-auto">
                        <button type="button" class="btn btn-outline-success" onclick="approveAll()">Approve All</button>
                        <button type="button" class="btn btn-outline-warning" onclick="approveSelected()">Approve Selected</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="exportToExcel()">Export</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Flux Table -->
    <div class="card">
        <div class="card-header">Flux Analysis Details</div>
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" class="form-check-input"></th>
                        <th>Entity</th>
                        <th>Account</th>
                        <th class="text-end">Actual USD</th>
                        <th class="text-end">Budget USD</th>
                        <th class="text-end">Variance</th>
                        <th class="text-end">% Change</th>
                        <th class="text-end">Threshold</th>
                        <th class="text-center">Risk Level</th>
                        <th class="text-center">AI Explanation</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in flux.rows %}
                    {% set v_budget = r.var_vs_budget or 0 %}
                    {% set is_material = (v_budget|abs) >= (r.threshold_usd or 0) %}
                    {% set is_forensic = r.ai_narrative and '[FORENSIC]' in r.ai_narrative %}
                    {% set pct_change = ((v_budget / r.budget_amount) * 100) if r.budget_amount != 0 else 0 %}
                    <tr class="{{ 'table-danger' if is_forensic else 'table-warning' if is_material else '' }}">
                        <td><input type="checkbox" class="form-check-input row-select" data-entity="{{ r.entity }}" data-account="{{ r.account }}"></td>
                        <td><strong>{{ r.entity }}</strong></td>
                        <td>{{ r.account }}</td>
                        <td class="text-end font-monospace">{{ r.actual_usd | format_currency }}</td>
                        <td class="text-end font-monospace">{{ r.budget_amount | format_currency }}</td>
                        <td class="text-end fw-bold font-monospace {{ 'text-danger' if v_budget < 0 else 'text-success' if v_budget > 0 else '' }}">
                            {{ v_budget | format_currency }}
                            {% if is_material %}
                                <i class="fas fa-exclamation-triangle text-warning ms-1" title="Material Variance"></i>
                            {% endif %}
                        </td>
                        <td class="text-end font-monospace small {{ 'text-danger' if pct_change|abs > 50 else 'text-warning' if pct_change|abs > 20 else '' }}">
                            {{ "%.1f"|format(pct_change) }}%
                        </td>
                        <td class="text-end font-monospace small text-muted">{{ r.threshold_usd | format_currency }}</td>
                        <td class="text-center">
                            {% if is_forensic %}
                                <span class="badge bg-danger"><i class="fas fa-fire me-1"></i>Forensic</span>
                            {% elif is_material %}
                                <span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>Material</span>
                            {% else %}
                                <span class="badge bg-success"><i class="fas fa-check me-1"></i>Normal</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if r.ai_narrative %}
                                <button class="btn btn-sm btn-outline-info" 
                                        data-entity="{{ r.entity }}" 
                                        data-account="{{ r.account }}" 
                                        data-narrative="{{ r.ai_narrative }}"
                                        onclick="showExplanation(this)" 
                                        title="View AI Explanation">
                                    <i class="fas fa-robot"></i>
                                </button>
                            {% else %}
                                <span class="text-muted small">No explanation</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                {% if not is_forensic and not is_material %}
                                    <button class="btn btn-outline-success" onclick="approve('{{ r.entity }}', '{{ r.account }}')"><i class="fas fa-check"></i></button>
                                {% endif %}
                                <button class="btn btn-outline-primary" onclick="showDetails('{{ r.entity }}', '{{ r.account }}')"><i class="fas fa-info"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <h5 class="mb-1">No Data</h5>
                            <p class="text-muted mb-0">No flux variances match the current filters.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Flux page JavaScript loaded');
    
    // Select all checkbox functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-select');
    
    console.log('Found selectAll:', !!selectAllCheckbox);
    console.log('Found row checkboxes:', rowCheckboxes.length);
    
    if (selectAllCheckbox && rowCheckboxes.length > 0) {
        selectAllCheckbox.addEventListener('change', function() {
            console.log('Select all clicked:', this.checked);
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // Update select all when individual checkboxes change
        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedCount = document.querySelectorAll('.row-select:checked').length;
                selectAllCheckbox.checked = checkedCount === rowCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
            });
        });
    } else {
        console.warn('Select all functionality not initialized - missing elements');
    }
});

// Filter functions
function clearFilters() {
    console.log('Clear filters clicked');
    window.location.href = '/flux';
}

// Bulk actions
function approveAll() {
    const allRows = document.querySelectorAll('.row-select');
    if (allRows.length === 0) {
        alert('No items to approve');
        return;
    }
    if (confirm(`Approve all ${allRows.length} items?`)) {
        console.log('Approving all items');
        // Implementation for bulk approval
    }
}

function approveSelected() {
    const selected = document.querySelectorAll('.row-select:checked');
    if (selected.length === 0) {
        alert('Please select items to approve');
        return;
    }
    if (confirm(`Approve ${selected.length} selected items?`)) {
        console.log('Approving', selected.length, 'items');
        // Implementation for bulk approval
    }
}

function exportToExcel() {
    console.log('Exporting to Excel');
    // Implementation for Excel export
}

function showExplanation(button) {
    const entity = button.getAttribute('data-entity');
    const account = button.getAttribute('data-account');
    const narrative = button.getAttribute('data-narrative');
    
    // Create modal content
    const modalContent = `
        <div class="modal fade" id="explanationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">AI Explanation: ${entity} - ${account}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>${narrative}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('explanationModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('explanationModal'));
    modal.show();
}

function approve(entity, account) {
    if (confirm(`Approve variance for ${entity} - ${account}?`)) {
        console.log(`Approving ${entity} - ${account}`);
        // Implementation for approval
    }
}

function showDetails(entity, account) {
    console.log(`Showing details for ${entity} - ${account}`);
    // Implementation for showing details modal
}
</script>
{% endblock %}
