{% extends "base.html" %}
{% block content %}
<div class="space-y-4">
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-semibold">FX Translation Analysis</h1>
    <div class="text-sm text-gray-600">Period: <span class="font-medium">{{ fx.period }}</span></div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    <div class="bg-white rounded border p-3">
      <div class="text-xs uppercase text-gray-500">Policy</div>
      <div class="mt-1 text-sm">Rate basis: <span class="font-medium">{{ fx.policy.rate_basis }}</span></div>
      <div class="text-sm">Tolerance (USD): <span class="font-medium">{{ fx.policy.tolerance_usd }}</span></div>
    </div>
    <div class="bg-white rounded border p-3">
      <div class="text-xs uppercase text-gray-500">Summary (filtered)</div>
      <div class="mt-1 text-sm">Rows: <span class="font-medium">{{ fx.count_filtered }}</span></div>
      <div class="text-sm">Total abs diff (USD): <span class="font-medium">{{ '%.2f'|format(fx.total_abs_diff_filtered) }}</span></div>
    </div>
    <div class="bg-white rounded border p-3">
      <div class="text-xs uppercase text-gray-500">Summary (full)</div>
      <div class="mt-1 text-sm">Rows: <span class="font-medium">{{ fx.summary.rows }}</span></div>
      <div class="text-sm">Total abs diff (USD): <span class="font-medium">{{ '%.2f'|format(fx.summary.total_abs_diff_usd) }}</span></div>
    </div>
  </div>

  <form class="bg-white p-4 rounded shadow grid grid-cols-1 md:grid-cols-4 gap-4"
        hx-get="/fx-table" hx-target="#fx-table-body" hx-swap="innerHTML">
    <div>
      <label class="block text-xs text-gray-600 mb-1">Entity</label>
      <select name="entity" class="w-full border rounded px-2 py-1">
        <option value="" {% if not fx.selected_entity %}selected{% endif %}>(All)</option>
        {% for e in fx.entities %}
          <option value="{{ e }}" {% if fx.selected_entity==e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs text-gray-600 mb-1">Currency</label>
      <select name="currency" class="w-full border rounded px-2 py-1">
        <option value="" {% if not fx.selected_currency %}selected{% endif %}>(All)</option>
        {% for c in fx.currencies %}
          <option value="{{ c }}" {% if fx.selected_currency==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="md:col-span-2 flex justify-end items-end gap-2">
      <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white text-sm px-3 py-2 rounded" onclick="this.form.reset(); htmx.trigger(this.form, 'submit')">Clear</button>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-2 rounded">Apply Filters</button>
    </div>
  </form>

  <div id="fx-table" class="bg-white rounded border overflow-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="w-8 px-2 py-2"></th>
          <th class="text-left px-3 py-2">Entity</th>
          <th class="text-left px-3 py-2">Account</th>
          <th class="text-left px-3 py-2">Currency</th>
          <th class="text-right px-3 py-2">Rate</th>
          <th class="text-right px-3 py-2">Computed USD</th>
          <th class="text-right px-3 py-2">Reported USD</th>
          <th class="text-right px-3 py-2">Diff USD</th>
          <th class="w-16 px-2 py-2 text-center">JE</th>
        </tr>
      </thead>
      <tbody id="fx-table-body">
        {% for r in fx.rows %}
        <tr class="border-t {% if r.diff_usd|abs > 500000 %}bg-red-50{% elif r.diff_usd|abs > 100000 %}bg-amber-50{% endif %}">
          <td class="px-2 py-2 text-center">
            <a title="Details" class="text-gray-500 hover:text-indigo-600" hx-get="/details?module=FX&period={{ fx.period }}&entity={{ r.entity }}&account={{ r.account }}" hx-target="#drawer-root" hx-swap="innerHTML">üîç</a>
          </td>
          <td class="px-3 py-2">{{ r.entity }}</td>
          <td class="px-3 py-2">{{ r.account }}</td>
          <td class="px-3 py-2">{{ r.currency }}</td>
          <td class="px-3 py-2 text-right">{{ '%.4f'|format(r.rate) }}</td>
          <td class="px-3 py-2 text-right">{{ '%.2f'|format(r.computed_usd) }}</td>
          <td class="px-3 py-2 text-right">{{ '%.2f'|format(r.reported_usd) }}</td>
          <td class="px-3 py-2 text-right font-medium {% if r.diff_usd >= 0 %}text-emerald-700{% else %}text-rose-700{% endif %}">
            {{ '%.2f'|format(r.diff_usd) }}
          </td>
          <td class="px-2 py-2 text-center">
            {% if r.diff_usd|abs > 0.01 %}
            <button type="button" 
                    class="inline-flex items-center px-2 py-1 text-xs font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded border border-indigo-200 transition-colors"
                    hx-post="/je/propose"
                    hx-vals='{"module": "FX", "scenario": "fx_translation", "source_data": {{ r | tojson }}, "period": "{{ fx.period }}", "entity": "{{ r.entity }}"}'
                    hx-target="body"
                    hx-swap="beforeend"
                    title="Propose journal entry for FX difference">
              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              JE
            </button>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="px-3 py-6 text-center text-gray-500">No rows match current filters.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
