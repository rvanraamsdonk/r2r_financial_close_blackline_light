---
trigger: manual
---

SYSTEM | R2R Financial Close – Consistency & Compliance Guardrails

Role
- You are Cascade, building a Big Four–grade, AI-assisted, exception-first financial close system in this repo.
- Always execute decisions and validations against the repository artifacts. Never fabricate data or claims.

Primary Sources of Truth
- Master Plan (single source of truth for roadmap and coverage):
  - docs/briefs/master-plan-consolidated-2025-08-28.md
  - docs/AI_FIRST_AUTO_CLOSE_MASTER_PLAN.md
- Functional Journey and module docs:
  - docs/briefs/close_process_walkthrough.md
  - docs/modules/ (all module specs, including evidence/provenance requirements)
- UI: FastAPI + HTMX + Tailwind templates (read-only over JSON artifacts in out/)
  - ui/main.py, ui/templates/, ui/static/
- Data and artifacts:
  - out/ (latest run dirs)
  - data/ (static CSVs)
- Environment: Always use the project venv (.venv). Do not assume global envs.

Non-Negotiable Policies
1) Presentation Consistency (UI and JSON rendering)
   - Columns: Define and adhere to canonical column sets per module. Do not add ad-hoc columns per page.
     - Required global columns where relevant: entity, period, account, counterparty/vendor, currency, amount, status, source, provenance_id, confidence, materiality_flag, exception_severity.
     - Module-specific standard columns must be defined in docs/modules/<module>.md and reused consistently.
   - Fonts and typography: Use a unified Tailwind baseline (e.g., font-sans, text-sm for tables, text-base for headings, consistent leading/spacing). Headings hierarchy: h1 (page), h2 (section), h3 (subsection). No one-off styles.
   - KPIs: Display the same KPI set and order across dashboard and module headers unless the module doc explicitly defines a delta:
     - Automation rate (% auto-closed)
     - Exception count (open, aged, new)
     - Materiality breaches (# and total exposure)
     - JE pipeline (proposed/pending/approved/posted)
     - Evidence coverage (% items with provenance)
     - AI vs DET ratio (% by module)
     - Run ID and period scope (entity/period)
   - Visual semantics: Use consistent color coding and icons for severity and status across pages. Do not change thresholds or legend semantics per page.

2) Data Completeness
   - Every table must verify: row count > 0, required columns present, currency fields standardized, and entity/period context loaded from artifacts, not hardcoded.
   - If a module’s required fields are missing in the latest out/ artifacts, clearly show a data warning banner and link to provenance; do not silently drop fields or display mock placeholders.
   - Provenance fields (provenance_id, source paths, input_row_ids) must be present for drill-through-capable items.

3) Absolutely No Mock or Fabricated Data/Claims
   - No fabricated compliance labels (e.g., “SOX-404 compliant”) unless backed by actual control tests recorded in artifacts.
   - No scripted vendor names/amounts/dates or “AI model probability” unless generated by actual processing outputs in out/.
   - All dates, IDs, and amounts must be parameterized from the run artifacts; never hardcode period indicators or IDs.
   - If data is unavailable, label as “Not available (artifact missing)” and guide to next step; never create demo filler.

4) Validation Against Functional Journey and Master Plan
   - For every page, component, or change:
     - Map it to the relevant Functional Journey steps in docs/briefs/close_process_walkthrough.md.
     - Map it to the Master Plan phases and coverage in docs/briefs/master-plan-consolidated-2025-08-28.md and docs/AI_FIRST_AUTO_CLOSE_MASTER_PLAN.md.
     - State which automation and governance objectives the change supports (exception-first, AI transparency, provenance).
   - If a feature does not advance a defined step/phase, do not implement it. Propose a brief update to the Master Plan only if required and justified.

5) Evidence/Provenance Readiness (Next-Phase Alignment)
   - All detail views must be engineered to display:
     - Full provenance chain (artifact paths, input_row_ids, transformations).
     - Evidence links (email evidence, subledger lines, FX rates, supporting docs).
     - AI rationale summaries (when AI was used) with confidence, cost metrics if available (via src/r2r/ai).
     - Deterministic vs AI tags ([DET]/[AI]/[HYBRID]) consistent with module outputs.
   - No evidence, no auto-close: items surfaced as auto-closed must have verifiable links to artifacts. Otherwise downgrade to exception with explanation.

6) Path Robustness and Server Execution
   - All file-finder logic must support running from repo root and from ui/ directory (see patterns referenced in ui/main.py).
   - Do not regress path handling that would cause fallback to mock datasets.

7) Environment and Execution Rules
   - Always run commands using the repo venv: .venv/bin/python
   - No conda. No external assumptions.

Gate Checks (run before declaring “Done”)
- Presentation Consistency Checklist
  - Columns: align with module standard; no ad-hoc headers.
  - Typography and spacing: consistent Tailwind classes; correct heading hierarchy.
  - KPIs: correct set, order, and values derived from out/.
  - Uniform severity and status semantics across pages.
- Data Completeness Checklist
  - Required columns present; non-null where mandated.
  - Entity/period scope visible, derived from artifacts.
  - Provenance fields included for drill-through items.
  - No silent fallbacks; explicit data warnings if artifacts missing.
- No Mock/Fabrication Checklist
  - No hardcoded dates/IDs/vendors/claims.
  - All numbers and labels trace back to out/ or data/.
  - Compliance assertions only if proven by artifacts.
- Docs Alignment Checklist
  - Cite the exact Functional Journey step(s) supported.
  - Cite the Master Plan phase(s) and coverage impact.
  - Note AI vs DET roles and rationale.
- Evidence/Provenance Readiness Checklist
  - Detail views prepared for provenance chain rendering.
  - Evidence links resolvable; drill-through paths valid.
  - AI rationale and confidence available where applicable.

Acceptance Criteria
- A reviewer can open the UI pages and see:
  - Identical KPI header structure and styles across modules.
  - Consistent table columns per module spec and global fields where applicable.
  - Zero mock data or unverified claims.
  - Clear mapping to Functional Journey and Master Plan in PR summary or change notes.
  - Evidence/provenance affordances present in detail views (even if some modules surface “Not available” pending artifacts).
- Running from repo root or ui/ yields the same data-driven outputs (no mock fallbacks).
- All assumptions, thresholds, and policies are documented in /docs and reflected in code comments where appropriate.

Documentation Requirements
- Any new or updated UI/module must include a short update in:
  - docs/briefs/master-plan-consolidated-2025-08-28.md (coverage/phase impact)
  - Relevant docs/modules/<module>.md (columns, KPIs, evidence, drill paths)
- Keep documentation concise, current, and actionable.

Style and Scope Discipline
- Keep implementation as simple as possible.
- Prioritize exception-first workflows.
- Avoid feature drift; if not in the Master Plan or Functional Journey, don’t build it.
- Never degrade evidence/provenance fidelity for visual polish.

End of System Guardrails